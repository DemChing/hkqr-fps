import Response from"../lib/event";import crc16 from"../lib/crc";import{extract,isAlphanumericSpecial,numberToValidId}from"../lib/utils";import{FPS_PARTICIPANT_LIST,FPS_CURRENCY_LIST}from"./config";import{FORMAT_INDICATOR,INITIATION_POINT,MERCHANT_CATEGORY_CODE,TRANSACTION_CURRENCY,TRANSACTION_AMOUNT,COUNTRY_CODE,MERCHANT_NAME,MERCHANT_CITY,ADDITIONAL_INFORMATION,CYCLIC_REDUNDANCY_CHECK,USEFUL_CONSTANT}from"../lib/constant";import{STATIC_QR_CODE,DYNAMIC_QR_CODE,MERCHANT_ACCOUNT_UNIQUE,MERCHANT_ACCOUNT_PARTICIPANT,MERCHANT_ACCOUNT_IDENTIFIER_FPS,MERCHANT_ACCOUNT_IDENTIFIER_MOBILE,MERCHANT_ACCOUNT_IDENTIFIER_EMAIL,MERCHANT_INFO_NAME,ADDITIONAL_INFO_BILL,ADDITIONAL_INFO_REFERENCE}from"../lib/constant";export default class FPS{constructor(){this.formatIndicator="01",this.initiationPoint="11",this.merchantAccount="26",this.merchantAccountInfo={uniqueIdentifier:"hk.com.hkicl"},this.merchantCategory="0000",this.transactionCurrency="HKD",this.countryCode="HK",this.merchantName="NA",this.merchantCity="HK"}static Silent(){Response.Silent()}static get BANK_STANDARD_CHARTERED(){return USEFUL_CONSTANT.BANK_STANDARD_CHARTERED}static get BANK_HSBC(){return USEFUL_CONSTANT.BANK_HSBC}static get BANK_BANK_OF_CHINA(){return USEFUL_CONSTANT.BANK_BANK_OF_CHINA}static get BANK_EAST_ASIA(){return USEFUL_CONSTANT.BANK_EAST_ASIA}static get BANK_DBS(){return USEFUL_CONSTANT.BANK_DBS}static get BANK_HANG_SANG(){return USEFUL_CONSTANT.BANK_HANG_SANG}static get BANK_CITIBANK(){return USEFUL_CONSTANT.BANK_CITIBANK}static get BANK_WECHAT(){return USEFUL_CONSTANT.BANK_WECHAT}static get BANK_TAP_N_GO(){return USEFUL_CONSTANT.BANK_TAP_N_GO}static get BANK_TNG(){return USEFUL_CONSTANT.BANK_TNG}static get BANK_ALIPAY(){return USEFUL_CONSTANT.BANK_ALIPAY}static get BANK_OCTOPUS(){return USEFUL_CONSTANT.BANK_OCTOPUS}static get BANK_PAYME(){return USEFUL_CONSTANT.BANK_PAYME}static get CURRENCY_HKD(){return USEFUL_CONSTANT.CURRENCY_HKD}static get CURRENCY_CNY(){return USEFUL_CONSTANT.CURRENCY_CNY}static get CURRENCY_TWD(){return USEFUL_CONSTANT.CURRENCY_TWD}static get CURRENCY_USD(){return USEFUL_CONSTANT.CURRENCY_USD}static get FPS_EMAIL_IRD_PROFITS_TAX(){return USEFUL_CONSTANT.FPS_EMAIL_IRD_PROFITS_TAX}static get FPS_EMAIL_IRD_SALARIES_TAX(){return USEFUL_CONSTANT.FPS_EMAIL_IRD_SALARIES_TAX}static get FPS_EMAIL_IRD_PERSONAL_ASSESSMENT(){return USEFUL_CONSTANT.FPS_EMAIL_IRD_PERSONAL_ASSESSMENT}static get FPS_ID_CLP(){return USEFUL_CONSTANT.FPS_ID_CLP}payload(t,e=""){return`${t}${numberToValidId(e.length)}${e}`}setAlphanumericSpecial(t,e){let n=new Response;return void 0===t?n.setError("Not Specified",!0):t.length>e?n.setError(`Length Exceeds Limit (>${e})`,!0):isAlphanumericSpecial(t)||n.setError("Should Contains Certain Characters Only (A-z0-9.@_+-)",!0),n}setNumeric(t,e=!1,n=13){let r,i=new Response;return void 0===t?i.setError("Not Specified",!0):r="string"==typeof t?t:"number"==typeof e?t.toFixed(e):t.toString(),i.isError()||(/^[0-9.]+$/.test(r)?parseFloat(r)<=0?i.setError("Exceeds Limit (<=0)",!0):r.length>n?i.setError(`Length Exceeds Limit (>${n}) (Including "." Character)`,!0):i.data=r:i.setError("Should Contains Certain Characters Only (0-9.)",!0)),i}parse(t){let e=this.extract(t);if(e.isError())return e;let n=JSON.parse(JSON.stringify(e.data));for(let t in n){if(e.isError())break;let r=n[t];if(t==FORMAT_INDICATOR);else if(t==INITIATION_POINT)r==STATIC_QR_CODE||r==DYNAMIC_QR_CODE?this.initiationPoint=r:e.setError(`Invalid Initiation Point (id=${t})`);else if(t==TRANSACTION_CURRENCY){r=r.toUpperCase();let n=Object.keys(FPS_CURRENCY_LIST).filter((t=>FPS_CURRENCY_LIST[t]==r));n.length>0?this.setCurrency(n[0]):e.setError(`Invalid Transaction Currency (id=${t})`)}else t==TRANSACTION_AMOUNT?this.setAmount(r):t==MERCHANT_NAME?this.merchantName=r:t==MERCHANT_CITY?this.merchantCity=r:t==ADDITIONAL_INFORMATION?this.setAdditionalInfo(r):t==CYCLIC_REDUNDANCY_CHECK||t==this.merchantAccount&&this.setMerchantAccount(r)}return e}extract(t=""){let e=new Response;if(0==t.length){if(e=this.generate(),e.isError())return e;t=e.data,delete e.data}let n=extract(t);if(1==n.length){let r=n[0],i=r[CYCLIC_REDUNDANCY_CHECK],a=CYCLIC_REDUNDANCY_CHECK+"04",o=t.split(`${a}${i}`)[0]+a;i&&crc16(o)==i?e.data=r:e.setError("Invalid Input - Invalid CRC")}else e.setError("Invalid Input");return e}generate(){let t="",e=new Response;t+=this.payload(FORMAT_INDICATOR,this.formatIndicator),t+=this.payload(INITIATION_POINT,this.initiationPoint);let n="";if(!this.merchantAccountInfo)return e.setError("Missing Merchant Account Information"),e;if(!this.merchantAccountInfo.uniqueIdentifier)return e.setError("Missing Merchant Unique Identifier"),e;if(n+=this.payload(MERCHANT_ACCOUNT_UNIQUE,this.merchantAccountInfo.uniqueIdentifier),this.merchantAccountInfo.paymentNetwork&&Object.keys(this.merchantAccountInfo.paymentNetwork).map((t=>{n+=this.payload(t,this.merchantAccountInfo.paymentNetwork[t])})),n.length>99)return e.setError("Merchant Account Information Length Exceeds Limit (>99)"),e;t+=this.payload(this.merchantAccount,n),t+=this.payload(MERCHANT_CATEGORY_CODE,this.merchantCategory),t+=this.payload(TRANSACTION_CURRENCY,FPS_CURRENCY_LIST[this.transactionCurrency]),this.transactionAmount&&parseFloat(this.transactionAmount)>0&&(t+=this.payload(TRANSACTION_AMOUNT,this.transactionAmount)),t+=this.payload(COUNTRY_CODE,this.countryCode),t+=this.payload(MERCHANT_NAME,this.merchantName),t+=this.payload(MERCHANT_CITY,this.merchantCity);let r="";return this.additionalInfo&&(this.additionalInfo.billNumber&&(r+=this.payload(ADDITIONAL_INFO_BILL,this.additionalInfo.billNumber)),this.additionalInfo.referenceLabel&&(r+=this.payload(ADDITIONAL_INFO_REFERENCE,this.additionalInfo.referenceLabel))),r.length>99?(e.setError("Additional Information Length Exceeds Limit (>99)"),e):(r.length>0&&(t+=this.payload(ADDITIONAL_INFORMATION,r)),this.cyclicRedundancyCheck=crc16(t+CYCLIC_REDUNDANCY_CHECK+"04"),t+=this.payload(CYCLIC_REDUNDANCY_CHECK,this.cyclicRedundancyCheck),e.data=t,e)}isStatic(){return this.initiationPoint==STATIC_QR_CODE}setStatic(){return this.initiationPoint=STATIC_QR_CODE,new Response}setDynamic(){return this.initiationPoint=DYNAMIC_QR_CODE,new Response}setMerchantAccount(t){let e=new Response;for(let n in t){if(e.isError())break;if(e=this.setAlphanumericSpecial(t[n],99),e.isError())e.setError(`Data ${e.message}`);else{if(this.merchantAccountInfo.paymentNetwork||(this.merchantAccountInfo.paymentNetwork={}),n==MERCHANT_ACCOUNT_UNIQUE)continue;if(n==MERCHANT_ACCOUNT_PARTICIPANT){if(!(t[n]in FPS_PARTICIPANT_LIST)){e.setError("Invalid Merchant Code");continue}}else if(n==MERCHANT_ACCOUNT_IDENTIFIER_FPS){if(!/^[0-9]+$/.test(t[n])){e.setError("FPS Identifier Should Contains Numbers Only (0-9)");continue}if(t[n].length<7||t[n].length>9){e.setError("Invalid FPS Identifier Length (7-9)");continue}}else if(n==MERCHANT_ACCOUNT_IDENTIFIER_MOBILE){if(!/^[0-9+-]+$/.test(t[n])){e.setError("Mobile Number Should Contains Certain Characters Only (0-9+-)");continue}if(/^[0-9]{8}$/.test(t[n]))t[n]=`+852-${t[n]}`;else if(/^852[0-9]{8}$/.test(t[n]))t[n]=`+${t[n].slice(0,3)}-${t[n].slice(3)}`;else if(!/^\+852-[0-9]{8}$/.test(t[n])){e.setError("Invalid Mobile Number");continue}}else if(n==MERCHANT_ACCOUNT_IDENTIFIER_EMAIL&&!/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/i.test(t[n])){e.setError("Invalid Email");continue}this.merchantAccountInfo.paymentNetwork[n]=t[n]}}return e}getBank(t=!1){var e;let n=new Response;return(null===(e=null==this?void 0:this.merchantAccountInfo)||void 0===e?void 0:e.paymentNetwork)&&MERCHANT_ACCOUNT_PARTICIPANT in this.merchantAccountInfo.paymentNetwork?(n.data=this.merchantAccountInfo.paymentNetwork[MERCHANT_ACCOUNT_PARTICIPANT],t&&(n.data=FPS_PARTICIPANT_LIST[n.data])):n.setError("Merchant Account Participant Code not set"),n}setBank(t){let e={};return e[MERCHANT_ACCOUNT_PARTICIPANT]=t,this.setMerchantAccount(e)}getFPSId(){var t;let e=new Response;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?e.data=this.merchantAccountInfo.paymentNetwork[MERCHANT_ACCOUNT_IDENTIFIER_FPS]:e.setError("FPS ID not set"),e}setFPSId(t){let e,n={};return e="number"==typeof t?t.toString():t,n[MERCHANT_ACCOUNT_IDENTIFIER_FPS]=e,this.setMerchantAccount(n)}getMobile(){var t;let e=new Response;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?e.data=this.merchantAccountInfo.paymentNetwork[MERCHANT_ACCOUNT_IDENTIFIER_MOBILE]:e.setError("Mobile Number not set"),e}setMobile(t){let e,n={};return e="number"==typeof t?t.toString():t,n[MERCHANT_ACCOUNT_IDENTIFIER_MOBILE]=e,this.setMerchantAccount(n)}getEmail(){var t;let e=new Response;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?e.data=this.merchantAccountInfo.paymentNetwork[MERCHANT_ACCOUNT_IDENTIFIER_EMAIL]:e.setError("Email not set"),e}setEmail(t){let e={};return e[MERCHANT_ACCOUNT_IDENTIFIER_EMAIL]=t,this.setMerchantAccount(e)}getAmount(t=!1){let e=new Response;return e.data=this.transactionAmount,t&&(e.data=parseFloat(e.data)),e}setAmount(t){let e=this.setNumeric(t);return e.isError()?e.setError(`Transaction Amount ${e.message}`):this.transactionAmount=e.data,e}setAdditionalInfo(t){let e=new Response;if(this.additionalInfo||(this.additionalInfo={}),ADDITIONAL_INFO_BILL in t){if(e=this.setAlphanumericSpecial(t[ADDITIONAL_INFO_BILL],25),e.isError())return e.setError(`Bill Number ${e.message}`),e;this.additionalInfo.billNumber=t[ADDITIONAL_INFO_BILL],delete t[MERCHANT_INFO_NAME]}if(ADDITIONAL_INFO_REFERENCE in t){if(e=this.setAlphanumericSpecial(t[ADDITIONAL_INFO_REFERENCE],25),e.isError())return e.setError(`Reference Label ${e.message}`),e;this.additionalInfo.referenceLabel=t[ADDITIONAL_INFO_REFERENCE],delete t[ADDITIONAL_INFO_REFERENCE]}for(let e in t)this.additionalInfo.extra||(this.additionalInfo.extra={}),this.additionalInfo.extra[e]=t[e];return e}getBillNumber(){var t;let e=new Response;return(null===(t=null==this?void 0:this.additionalInfo)||void 0===t?void 0:t.billNumber)?e.data=this.additionalInfo.billNumber:e.setError("Bill Number not set"),e}setBillNumber(t){let e={};return e[ADDITIONAL_INFO_BILL]=t,this.setAdditionalInfo(e)}getReference(){var t;let e=new Response;return(null===(t=null==this?void 0:this.additionalInfo)||void 0===t?void 0:t.referenceLabel)?e.data=this.additionalInfo.referenceLabel:e.setError("Reference Label not set"),e}setReference(t){let e={};return e[ADDITIONAL_INFO_REFERENCE]=t,this.setAdditionalInfo(e)}setHKD(){return this.setCurrency(FPS.CURRENCY_HKD)}setCNY(){return this.setCurrency(FPS.CURRENCY_CNY)}getCurrency(t=!1){let e=new Response;return e.data=this.transactionCurrency,t&&(e.data=FPS_CURRENCY_LIST[e.data]),e}setCurrency(t){t=t.toUpperCase();let e=new Response;return t in FPS_CURRENCY_LIST?this.transactionCurrency=t:e.setError("Invalid Currency Code"),e}}"undefined"==typeof window||window.FPS||(window.FPS=FPS);
//# sourceMappingURL=index.js.map
