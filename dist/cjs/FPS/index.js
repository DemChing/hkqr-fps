"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});const event_1=__importDefault(require("../lib/event")),crc_1=__importDefault(require("../lib/crc")),utils_1=require("../lib/utils"),config_1=require("./config"),constant_1=require("../lib/constant"),constant_2=require("../lib/constant");class FPS{constructor(){this.formatIndicator="01",this.initiationPoint="11",this.merchantAccount="26",this.merchantAccountInfo={uniqueIdentifier:"hk.com.hkicl"},this.merchantCategory="0000",this.transactionCurrency="HKD",this.countryCode="HK",this.merchantName="NA",this.merchantCity="HK"}static Silent(){event_1.default.Silent()}static get BANK_STANDARD_CHARTERED(){return constant_1.USEFUL_CONSTANT.BANK_STANDARD_CHARTERED}static get BANK_HSBC(){return constant_1.USEFUL_CONSTANT.BANK_HSBC}static get BANK_BANK_OF_CHINA(){return constant_1.USEFUL_CONSTANT.BANK_BANK_OF_CHINA}static get BANK_EAST_ASIA(){return constant_1.USEFUL_CONSTANT.BANK_EAST_ASIA}static get BANK_DBS(){return constant_1.USEFUL_CONSTANT.BANK_DBS}static get BANK_HANG_SANG(){return constant_1.USEFUL_CONSTANT.BANK_HANG_SANG}static get BANK_CITIBANK(){return constant_1.USEFUL_CONSTANT.BANK_CITIBANK}static get BANK_WECHAT(){return constant_1.USEFUL_CONSTANT.BANK_WECHAT}static get BANK_TAP_N_GO(){return constant_1.USEFUL_CONSTANT.BANK_TAP_N_GO}static get BANK_TNG(){return constant_1.USEFUL_CONSTANT.BANK_TNG}static get BANK_ALIPAY(){return constant_1.USEFUL_CONSTANT.BANK_ALIPAY}static get BANK_OCTOPUS(){return constant_1.USEFUL_CONSTANT.BANK_OCTOPUS}static get BANK_PAYME(){return constant_1.USEFUL_CONSTANT.BANK_PAYME}static get CURRENCY_HKD(){return constant_1.USEFUL_CONSTANT.CURRENCY_HKD}static get CURRENCY_CNY(){return constant_1.USEFUL_CONSTANT.CURRENCY_CNY}static get CURRENCY_TWD(){return constant_1.USEFUL_CONSTANT.CURRENCY_TWD}static get CURRENCY_USD(){return constant_1.USEFUL_CONSTANT.CURRENCY_USD}static get FPS_EMAIL_IRD_PROFITS_TAX(){return constant_1.USEFUL_CONSTANT.FPS_EMAIL_IRD_PROFITS_TAX}static get FPS_EMAIL_IRD_SALARIES_TAX(){return constant_1.USEFUL_CONSTANT.FPS_EMAIL_IRD_SALARIES_TAX}static get FPS_EMAIL_IRD_PERSONAL_ASSESSMENT(){return constant_1.USEFUL_CONSTANT.FPS_EMAIL_IRD_PERSONAL_ASSESSMENT}static get FPS_ID_CLP(){return constant_1.USEFUL_CONSTANT.FPS_ID_CLP}payload(t,n=""){return`${t}${utils_1.numberToValidId(n.length)}${n}`}setAlphanumericSpecial(t,n){let e=new event_1.default;return void 0===t?e.setError("Not Specified",!0):t.length>n?e.setError(`Length Exceeds Limit (>${n})`,!0):utils_1.isAlphanumericSpecial(t)||e.setError("Should Contains Certain Characters Only (A-z0-9.@_+-)",!0),e}setNumeric(t,n=!1,e=13){let r,i=new event_1.default;return void 0===t?i.setError("Not Specified",!0):r="string"==typeof t?t:"number"==typeof n?t.toFixed(n):t.toString(),i.isError()||(/^[0-9.]+$/.test(r)?parseFloat(r)<=0?i.setError("Exceeds Limit (<=0)",!0):r.length>e?i.setError(`Length Exceeds Limit (>${e}) (Including "." Character)`,!0):i.data=r:i.setError("Should Contains Certain Characters Only (0-9.)",!0)),i}parse(t){let n=this.extract(t);if(n.isError())return n;let e=JSON.parse(JSON.stringify(n.data));for(let t in e){if(n.isError())break;let r=e[t];if(t==constant_1.FORMAT_INDICATOR);else if(t==constant_1.INITIATION_POINT)r==constant_2.STATIC_QR_CODE||r==constant_2.DYNAMIC_QR_CODE?this.initiationPoint=r:n.setError(`Invalid Initiation Point (id=${t})`);else if(t==constant_1.TRANSACTION_CURRENCY){r=r.toUpperCase();let e=Object.keys(config_1.FPS_CURRENCY_LIST).filter((t=>config_1.FPS_CURRENCY_LIST[t]==r));e.length>0?this.setCurrency(e[0]):n.setError(`Invalid Transaction Currency (id=${t})`)}else t==constant_1.TRANSACTION_AMOUNT?this.setAmount(r):t==constant_1.MERCHANT_NAME?this.merchantName=r:t==constant_1.MERCHANT_CITY?this.merchantCity=r:t==constant_1.ADDITIONAL_INFORMATION?this.setAdditionalInfo(r):t==constant_1.CYCLIC_REDUNDANCY_CHECK||t==this.merchantAccount&&this.setMerchantAccount(r)}return n}extract(t=""){let n=new event_1.default;if(0==t.length){if(n=this.generate(),n.isError())return n;t=n.data,delete n.data}let e=utils_1.extract(t);if(1==e.length){let r=e[0],i=r[constant_1.CYCLIC_REDUNDANCY_CHECK],a=constant_1.CYCLIC_REDUNDANCY_CHECK+"04",o=t.split(`${a}${i}`)[0]+a;i&&crc_1.default(o)==i?n.data=r:n.setError("Invalid Input - Invalid CRC")}else n.setError("Invalid Input");return n}generate(){let t="",n=new event_1.default;t+=this.payload(constant_1.FORMAT_INDICATOR,this.formatIndicator),t+=this.payload(constant_1.INITIATION_POINT,this.initiationPoint);let e="";if(!this.merchantAccountInfo)return n.setError("Missing Merchant Account Information"),n;if(!this.merchantAccountInfo.uniqueIdentifier)return n.setError("Missing Merchant Unique Identifier"),n;if(e+=this.payload(constant_2.MERCHANT_ACCOUNT_UNIQUE,this.merchantAccountInfo.uniqueIdentifier),this.merchantAccountInfo.paymentNetwork&&Object.keys(this.merchantAccountInfo.paymentNetwork).map((t=>{e+=this.payload(t,this.merchantAccountInfo.paymentNetwork[t])})),e.length>99)return n.setError("Merchant Account Information Length Exceeds Limit (>99)"),n;t+=this.payload(this.merchantAccount,e),t+=this.payload(constant_1.MERCHANT_CATEGORY_CODE,this.merchantCategory),t+=this.payload(constant_1.TRANSACTION_CURRENCY,config_1.FPS_CURRENCY_LIST[this.transactionCurrency]),this.transactionAmount&&parseFloat(this.transactionAmount)>0&&(t+=this.payload(constant_1.TRANSACTION_AMOUNT,this.transactionAmount)),t+=this.payload(constant_1.COUNTRY_CODE,this.countryCode),t+=this.payload(constant_1.MERCHANT_NAME,this.merchantName),t+=this.payload(constant_1.MERCHANT_CITY,this.merchantCity);let r="";return this.additionalInfo&&(this.additionalInfo.billNumber&&(r+=this.payload(constant_2.ADDITIONAL_INFO_BILL,this.additionalInfo.billNumber)),this.additionalInfo.referenceLabel&&(r+=this.payload(constant_2.ADDITIONAL_INFO_REFERENCE,this.additionalInfo.referenceLabel))),r.length>99?(n.setError("Additional Information Length Exceeds Limit (>99)"),n):(r.length>0&&(t+=this.payload(constant_1.ADDITIONAL_INFORMATION,r)),this.cyclicRedundancyCheck=crc_1.default(t+constant_1.CYCLIC_REDUNDANCY_CHECK+"04"),t+=this.payload(constant_1.CYCLIC_REDUNDANCY_CHECK,this.cyclicRedundancyCheck),n.data=t,n)}isStatic(){return this.initiationPoint==constant_2.STATIC_QR_CODE}setStatic(){return this.initiationPoint=constant_2.STATIC_QR_CODE,new event_1.default}setDynamic(){return this.initiationPoint=constant_2.DYNAMIC_QR_CODE,new event_1.default}setMerchantAccount(t){let n=new event_1.default;for(let e in t){if(n.isError())break;if(n=this.setAlphanumericSpecial(t[e],99),n.isError())n.setError(`Data ${n.message}`);else{if(this.merchantAccountInfo.paymentNetwork||(this.merchantAccountInfo.paymentNetwork={}),e==constant_2.MERCHANT_ACCOUNT_UNIQUE)continue;if(e==constant_2.MERCHANT_ACCOUNT_PARTICIPANT){if(!(t[e]in config_1.FPS_PARTICIPANT_LIST)){n.setError("Invalid Merchant Code");continue}}else if(e==constant_2.MERCHANT_ACCOUNT_IDENTIFIER_FPS){if(!/^[0-9]+$/.test(t[e])){n.setError("FPS Identifier Should Contains Numbers Only (0-9)");continue}if(t[e].length<7||t[e].length>9){n.setError("Invalid FPS Identifier Length (7-9)");continue}}else if(e==constant_2.MERCHANT_ACCOUNT_IDENTIFIER_MOBILE){if(!/^[0-9+-]+$/.test(t[e])){n.setError("Mobile Number Should Contains Certain Characters Only (0-9+-)");continue}if(/^[0-9]{8}$/.test(t[e]))t[e]=`+852-${t[e]}`;else if(/^852[0-9]{8}$/.test(t[e]))t[e]=`+${t[e].slice(0,3)}-${t[e].slice(3)}`;else if(!/^\+852-[0-9]{8}$/.test(t[e])){n.setError("Invalid Mobile Number");continue}}else if(e==constant_2.MERCHANT_ACCOUNT_IDENTIFIER_EMAIL&&!/(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/i.test(t[e])){n.setError("Invalid Email");continue}this.merchantAccountInfo.paymentNetwork[e]=t[e]}}return n}getBank(t=!1){var n;let e=new event_1.default;return(null===(n=null==this?void 0:this.merchantAccountInfo)||void 0===n?void 0:n.paymentNetwork)&&constant_2.MERCHANT_ACCOUNT_PARTICIPANT in this.merchantAccountInfo.paymentNetwork?(e.data=this.merchantAccountInfo.paymentNetwork[constant_2.MERCHANT_ACCOUNT_PARTICIPANT],t&&(e.data=config_1.FPS_PARTICIPANT_LIST[e.data])):e.setError("Merchant Account Participant Code not set"),e}setBank(t){let n={};return n[constant_2.MERCHANT_ACCOUNT_PARTICIPANT]=t,this.setMerchantAccount(n)}getFPSId(){var t;let n=new event_1.default;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?n.data=this.merchantAccountInfo.paymentNetwork[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_FPS]:n.setError("FPS ID not set"),n}setFPSId(t){let n,e={};return n="number"==typeof t?t.toString():t,e[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_FPS]=n,this.setMerchantAccount(e)}getMobile(){var t;let n=new event_1.default;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?n.data=this.merchantAccountInfo.paymentNetwork[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_MOBILE]:n.setError("Mobile Number not set"),n}setMobile(t){let n,e={};return n="number"==typeof t?t.toString():t,e[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_MOBILE]=n,this.setMerchantAccount(e)}getEmail(){var t;let n=new event_1.default;return(null===(t=null==this?void 0:this.merchantAccountInfo)||void 0===t?void 0:t.paymentNetwork)?n.data=this.merchantAccountInfo.paymentNetwork[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_EMAIL]:n.setError("Email not set"),n}setEmail(t){let n={};return n[constant_2.MERCHANT_ACCOUNT_IDENTIFIER_EMAIL]=t,this.setMerchantAccount(n)}getAmount(t=!1){let n=new event_1.default;return n.data=this.transactionAmount,t&&(n.data=parseFloat(n.data)),n}setAmount(t){let n=this.setNumeric(t);return n.isError()?n.setError(`Transaction Amount ${n.message}`):this.transactionAmount=n.data,n}setAdditionalInfo(t){let n=new event_1.default;if(this.additionalInfo||(this.additionalInfo={}),constant_2.ADDITIONAL_INFO_BILL in t){if(n=this.setAlphanumericSpecial(t[constant_2.ADDITIONAL_INFO_BILL],25),n.isError())return n.setError(`Bill Number ${n.message}`),n;this.additionalInfo.billNumber=t[constant_2.ADDITIONAL_INFO_BILL],delete t[constant_2.MERCHANT_INFO_NAME]}if(constant_2.ADDITIONAL_INFO_REFERENCE in t){if(n=this.setAlphanumericSpecial(t[constant_2.ADDITIONAL_INFO_REFERENCE],25),n.isError())return n.setError(`Reference Label ${n.message}`),n;this.additionalInfo.referenceLabel=t[constant_2.ADDITIONAL_INFO_REFERENCE],delete t[constant_2.ADDITIONAL_INFO_REFERENCE]}for(let n in t)this.additionalInfo.extra||(this.additionalInfo.extra={}),this.additionalInfo.extra[n]=t[n];return n}getBillNumber(){var t;let n=new event_1.default;return(null===(t=null==this?void 0:this.additionalInfo)||void 0===t?void 0:t.billNumber)?n.data=this.additionalInfo.billNumber:n.setError("Bill Number not set"),n}setBillNumber(t){let n={};return n[constant_2.ADDITIONAL_INFO_BILL]=t,this.setAdditionalInfo(n)}getReference(){var t;let n=new event_1.default;return(null===(t=null==this?void 0:this.additionalInfo)||void 0===t?void 0:t.referenceLabel)?n.data=this.additionalInfo.referenceLabel:n.setError("Reference Label not set"),n}setReference(t){let n={};return n[constant_2.ADDITIONAL_INFO_REFERENCE]=t,this.setAdditionalInfo(n)}setHKD(){return this.setCurrency(FPS.CURRENCY_HKD)}setCNY(){return this.setCurrency(FPS.CURRENCY_CNY)}getCurrency(t=!1){let n=new event_1.default;return n.data=this.transactionCurrency,t&&(n.data=config_1.FPS_CURRENCY_LIST[n.data]),n}setCurrency(t){t=t.toUpperCase();let n=new event_1.default;return t in config_1.FPS_CURRENCY_LIST?this.transactionCurrency=t:n.setError("Invalid Currency Code"),n}}exports.default=FPS,"undefined"==typeof window||window.FPS||(window.FPS=FPS);
//# sourceMappingURL=index.js.map
